<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test de Manejo de Imágenes</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-image {
            max-width: 300px;
            border: 1px solid #ccc;
            margin: 10px 0;
            display: block;
        }
        .image-container {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .warning {
            color: orange;
            font-weight: bold;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background-color: #f8f8f8;
            border-radius: 5px;
        }
        button {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
        
        /* Sección para depuración */
        .debug-section {
            margin-top: 30px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .debug-section h3 {
            margin-top: 0;
        }
    </style>
</head>
<body>
    <h1>Test de Manejo de Imágenes</h1>
    
    <div class="status" id="status"></div>
    
    <div id="imageUploadTest" class="image-container">
        <h2>1. Prueba de Subida de Imagen</h2>
        <input type="file" id="imageInput" accept="image/*">
        <button id="uploadImageBtn">Subir Imagen</button>
        <div id="uploadResult"></div>
        <div>
            <h3>Vista previa:</h3>
            <img id="uploadedImage" class="test-image" alt="Vista previa de imagen subida">
        </div>
    </div>

    <div id="imageIdTest" class="image-container">
        <h2>2. Prueba de Carga de Imagen por ID</h2>
        <input type="text" id="imageIdInput" placeholder="ID de imagen">
        <button id="loadImageBtn">Cargar Imagen</button>
        <div id="loadResult"></div>
        <div>
            <h3>Vista previa:</h3>
            <img id="loadedImage" class="test-image" alt="Vista previa de imagen cargada">
        </div>
    </div>

    <div id="testCreation" class="image-container">
        <h2>3. Prueba de Creación de Test con Imagen</h2>
        <button id="createTestBtn">Crear Test con Imagen</button>
        <div id="createResult"></div>
        <textarea id="testData" readonly placeholder="Aquí aparecerán los datos del test..."></textarea>
    </div>

    <div id="testLoading" class="image-container">
        <h2>4. Prueba de Carga de Test</h2>
        <input type="text" id="testIdInput" placeholder="ID del test">
        <button id="loadTestBtn">Cargar Test</button>
        <div id="loadTestResult"></div>
        <textarea id="loadedTestData" readonly placeholder="Aquí aparecerán los datos del test cargado..."></textarea>
        <div id="imagePreview">
            <h3>Vista previa de imagen del test:</h3>
            <img id="testImage" class="test-image" alt="Vista previa de imagen del test">
            <p id="imgErrorMessages"></p>
        </div>
    </div>
    
    <div class="debug-section">
        <h3>Depuración de Imágenes</h3>
        <div>
            <button id="debugImageBtn">Probar URL Directa</button>
            <input type="text" id="debugImageUrl" placeholder="URL de imagen para prueba" style="width: 70%;">
        </div>
        <div id="debugResult" style="margin-top: 10px;"></div>
    </div>

    <script>
        // Configuración
        const API_URL = 'https://quickbooks-backend.vercel.app/api';
        let uploadedImageData = null;
        let uploadedImageId = null;
        let createdTestId = null;
        
        // Función para mostrar estado general
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.innerHTML = `<p class="${type}">${message}</p>`;
        }
        
        // Inicialización
        updateStatus('Herramienta de prueba para el manejo de imágenes entre frontend y backend.');
        
        // Función para verificar que la imagen carga correctamente
        function checkImageLoading(imgElement, errorContainer) {
            imgElement.onload = function() {
                if (errorContainer) {
                    errorContainer.innerHTML = '<span class="success">✓ Imagen cargada correctamente</span>';
                }
            };
            imgElement.onerror = function() {
                if (errorContainer) {
                    errorContainer.innerHTML = '<span class="error">✗ Error al cargar la imagen</span>';
                }
            };
        }
        
        // Inicializar evento para todas las imágenes
        checkImageLoading(document.getElementById('uploadedImage'));
        checkImageLoading(document.getElementById('loadedImage'));
        checkImageLoading(document.getElementById('testImage'), document.getElementById('imgErrorMessages'));

        // 1. Prueba de subida de imagen
        document.getElementById('uploadImageBtn').addEventListener('click', async () => {
            const fileInput = document.getElementById('imageInput');
            const resultDiv = document.getElementById('uploadResult');
            
            if (!fileInput.files || fileInput.files.length === 0) {
                resultDiv.innerHTML = '<p class="error">Por favor selecciona una imagen</p>';
                return;
            }

            const file = fileInput.files[0];
            
            // Leer como base64
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    uploadedImageData = e.target.result; // data:image/jpeg;base64,...
                    
                    // Subir a través del endpoint de imágenes
                    const response = await fetch(`${API_URL}/images?action=upload`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            imageData: uploadedImageData,
                            fileName: file.name
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        uploadedImageId = data.imageId;
                        resultDiv.innerHTML = `
                            <p class="success">Imagen subida correctamente</p>
                            <p>ID: ${data.imageId}</p>
                            <p>URL: ${data.url}</p>
                        `;
                        document.getElementById('uploadedImage').src = data.url;
                        document.getElementById('imageIdInput').value = data.imageId;
                    } else {
                        resultDiv.innerHTML = `
                            <p class="error">Error al subir: ${data.error}</p>
                            <p>${data.details || ''}</p>
                        `;
                    }
                } catch (error) {
                    resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
                }
            };
            
            reader.readAsDataURL(file);
        });

        // 2. Prueba de carga de imagen por ID
        document.getElementById('loadImageBtn').addEventListener('click', async () => {
            const imageId = document.getElementById('imageIdInput').value.trim();
            const resultDiv = document.getElementById('loadResult');
            const imageElement = document.getElementById('loadedImage');
            
            if (!imageId) {
                resultDiv.innerHTML = '<p class="error">Por favor ingresa un ID de imagen</p>';
                return;
            }
            
            try {
                // Hacer una solicitud al endpoint de imágenes sin redirección
                const response = await fetch(`${API_URL}/images?id=${imageId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Usar directamente la URL del blob en lugar de la redirección
                    imageElement.src = data.url;
                    
                    resultDiv.innerHTML = `
                        <p class="success">Imagen cargada correctamente</p>
                        <p>URL: ${data.url}</p>
                        <p>Tipo: ${data.type}</p>
                        <p>Tamaño: ${data.size} bytes</p>
                    `;
                } else {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p class="error">Error al cargar: ${data.error}</p>`;
                    
                    // Intentar cargarla con redirección como fallback
                    const imageUrl = `${API_URL}/images?id=${imageId}&redirect=1`;
                    resultDiv.innerHTML += `<p>Intentando método alternativo...</p>`;
                    imageElement.src = imageUrl;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // 3. Prueba de Creación de Test con Imagen
        document.getElementById('createTestBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('createResult');
            
            if (!uploadedImageId && !uploadedImageData) {
                resultDiv.innerHTML = '<p class="error">Por favor primero sube una imagen</p>';
                return;
            }
            
            try {
                // Generar un ID único para esta pregunta que incluya la fecha
                const questionId = "q_" + new Date().getTime();
                
                // Crear un test simple con la imagen subida
                const testData = {
                    name: "Test de Imagen " + new Date().toISOString(),
                    description: "Test creado para probar el manejo de imágenes",
                    questions: [
                        {
                            id: questionId,  // ID único y predecible para la pregunta
                            title: "Pregunta con Imagen",
                            description: "Esta pregunta tiene una imagen asociada",
                            type: "clickArea",
                            // Si tenemos imageId de una subida previa, usarlo; si no, usaremos el ID de la pregunta
                            imageId: uploadedImageId || questionId,
                            // Incluir los datos de la imagen también
                            image: uploadedImageData,
                            // Incluir el dato en _localFile para compatibilidad
                            _localFile: uploadedImageData
                        }
                    ]
                };
                
                document.getElementById('testData').value = JSON.stringify(testData, null, 2);
                
                // Guardar el test
                const response = await fetch(`${API_URL}/save-test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(testData)
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    createdTestId = data.id;
                    resultDiv.innerHTML = `
                        <p class="success">Test creado correctamente</p>
                        <p>ID del test: ${data.id}</p>
                        <p>ID de la pregunta: ${questionId}</p>
                        <p>Primera pregunta tiene imageId: ${data.questions[0].imageId || 'No disponible'}</p>
                        <p>Primera pregunta tiene image: ${data.questions[0].image ? 'Sí' : 'No'}</p>
                    `;
                    
                    // Si la respuesta incluye una URL de imagen, mostrarla
                    if (data.questions[0].image) {
                        document.getElementById('testImage').src = data.questions[0].image;
                        resultDiv.innerHTML += `<p>URL de la imagen: ${data.questions[0].image}</p>`;
                    }
                    
                    // Actualizar el campo de ID para la siguiente prueba
                    document.getElementById('testIdInput').value = data.id;
                } else {
                    resultDiv.innerHTML = `
                        <p class="error">Error al crear test: ${data.error}</p>
                        <p>${data.details || ''}</p>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // 4. Prueba de carga de test
        document.getElementById('loadTestBtn').addEventListener('click', async () => {
            const testId = document.getElementById('testIdInput').value.trim();
            const resultDiv = document.getElementById('loadTestResult');
            
            if (!testId) {
                resultDiv.innerHTML = '<p class="error">Por favor ingresa un ID de test</p>';
                return;
            }
            
            try {
                // Cargar el test
                const response = await fetch(`${API_URL}/load-tests?id=${testId}`);
                
                if (response.ok) {
                    const testData = await response.json();
                    document.getElementById('loadedTestData').value = JSON.stringify(testData, null, 2);
                    
                    if (testData.questions && testData.questions.length > 0) {
                        const question = testData.questions[0];
                        resultDiv.innerHTML = `
                            <p class="success">Test cargado correctamente</p>
                            <p>Test ID: ${testData.id}</p>
                            <p>Nombre: ${testData.name}</p>
                            <p>Primera pregunta tiene imageId: ${question.imageId || 'No disponible'}</p>
                            <p>Primera pregunta tiene image URL: ${question.image || 'No disponible'}</p>
                        `;
                        
                        // Si tenemos una URL de imagen, intentar cargarla directamente de Vercel Blob
                        if (question.imageId) {
                            // Intentar primero con el endpoint directo sin redirección
                            try {
                                const imgResponse = await fetch(`${API_URL}/images?id=${question.imageId}`);
                                if (imgResponse.ok) {
                                    const imgData = await imgResponse.json();
                                    // Usar directamente la URL del blob en lugar de la redirección
                                    if (imgData.url) {
                                        document.getElementById('testImage').src = imgData.url;
                                        resultDiv.innerHTML += `<p class="success">Imagen cargada directamente desde Vercel Blob</p>`;
                                    } else if (question.image) {
                                        document.getElementById('testImage').src = question.image;
                                        resultDiv.innerHTML += `<p class="success">Usando URL de imagen del test</p>`;
                                    }
                                } else {
                                    // Si falla, usar la URL proporcionada en el test
                                    if (question.image) {
                                        document.getElementById('testImage').src = question.image;
                                        resultDiv.innerHTML += `<p class="success">Usando URL de imagen del test (API directa falló)</p>`;
                                    } else {
                                        resultDiv.innerHTML += `<p class="error">No se pudo cargar la imagen</p>`;
                                    }
                                }
                            } catch (imgError) {
                                // Si falla por cualquier razón, intentar con la URL del test
                                if (question.image) {
                                    document.getElementById('testImage').src = question.image;
                                    resultDiv.innerHTML += `<p class="success">Usando URL de imagen del test (excepción en API)</p>`;
                                } else {
                                    resultDiv.innerHTML += `<p class="error">Error al cargar la imagen: ${imgError.message}</p>`;
                                }
                            }
                        } else if (question.image) {
                            // Si solo tenemos URL pero no ID
                            document.getElementById('testImage').src = question.image;
                            resultDiv.innerHTML += `<p class="success">Usando URL de imagen sin imageId</p>`;
                        } else {
                            resultDiv.innerHTML += `<p class="error">El test no tiene imágenes</p>`;
                        }
                    } else {
                        resultDiv.innerHTML = `
                            <p class="error">El test no tiene preguntas con imágenes</p>
                        `;
                    }
                } else {
                    const data = await response.json();
                    resultDiv.innerHTML = `<p class="error">Error al cargar test: ${data.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p class="error">Error: ${error.message}</p>`;
            }
        });

        // Código de depuración de imágenes
        document.getElementById('debugImageBtn').addEventListener('click', async () => {
            const urlInput = document.getElementById('debugImageUrl');
            const resultDiv = document.getElementById('debugResult');
            const url = urlInput.value.trim();
            
            if (!url) {
                resultDiv.innerHTML = '<p class="error">Por favor ingresa una URL</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p>Probando carga directa de URL...</p>';
            
            // Crear una nueva imagen para probar la carga
            const img = new Image();
            img.className = 'test-image';
            img.crossOrigin = 'anonymous';  // Intentar con CORS
            
            img.onload = function() {
                resultDiv.innerHTML = '<p class="success">URL cargada correctamente</p>';
                resultDiv.appendChild(img);
            };
            
            img.onerror = function() {
                resultDiv.innerHTML = '<p class="error">Error al cargar la URL directamente</p>';
                
                // Intentar con un iframe como alternativa
                resultDiv.innerHTML += '<p>Intentando con iframe...</p>';
                
                const iframe = document.createElement('iframe');
                iframe.style.width = '300px';
                iframe.style.height = '200px';
                iframe.style.border = '1px solid #ccc';
                
                iframe.onload = function() {
                    resultDiv.innerHTML += '<p class="success">Iframe cargado</p>';
                };
                
                iframe.onerror = function() {
                    resultDiv.innerHTML += '<p class="error">Error al cargar iframe</p>';
                };
                
                iframe.src = url;
                resultDiv.appendChild(iframe);
            };
            
            img.src = url;
        });
    </script>
</body>
</html> 